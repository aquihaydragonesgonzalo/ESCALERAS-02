<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <!-- Added viewport-fit=cover for full screen on notch devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>StairMaster Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD - Global Variables) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#0f172a" />
    <style>
      /* Fix for mobile height to prevent browser bar issues */
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent body scroll, handle inside App */
        background-color: #0f172a;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Safe area padding utility */
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
      .pt-safe {
        padding-top: env(safe-area-inset-top);
      }
      
      /* Custom scrollbar for settings */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      
      /* Hide number input arrows */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-50 antialiased selection:bg-emerald-500 selection:text-white">
    <!-- Loading State (Visible until React mounts) -->
    <div id="root" class="h-full w-full flex items-center justify-center">
      <div class="flex flex-col items-center animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-emerald-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 6l4 14"/><path d="M12 6l4 14"/><path d="M8 8v12"/><path d="M4 10v10"/></svg>
        <span class="text-slate-400 font-mono text-sm">Cargando App...</span>
      </div>
    </div>
    
    <!-- APPLICATION LOGIC INLINED FOR COMPATIBILITY -->
    <script type="text/babel" data-presets="typescript,react">
      // Access global React variables provided by the UMD scripts
      const { useState, useEffect, useCallback, useRef, useMemo } = React;
      const { createRoot } = ReactDOM;

      // --- Types & Constants ---
      const STEPS_PER_FLIGHT = 31;
      const STEP_HEIGHT_METERS = 0.19; // 19 cm per step
      const DISTANCE_PER_FLIGHT_METERS = 16; // 16 meters per flight
      const STORAGE_KEY = 'stairmaster_history_v1';
      const GOAL_KEY = 'stairmaster_goal_config';

      // --- Components ---

      const StatCard = ({ label, value, subLabel, colorClass = "text-white" }) => {
        return (
          <div className="bg-slate-800 rounded-2xl p-3 sm:p-4 flex flex-col items-center justify-center shadow-lg border border-slate-700 w-full h-full">
            <span className="text-slate-400 text-[10px] sm:text-xs uppercase tracking-wider font-semibold mb-1 truncate w-full text-center">{label}</span>
            <span className={`text-2xl sm:text-3xl font-bold ${colorClass}`}>{value}</span>
            {subLabel && <span className="text-slate-500 text-[10px] sm:text-xs mt-1">{subLabel}</span>}
          </div>
        );
      };

      const ProgressBar = ({ current, target, label, colorClass = "bg-emerald-500" }) => {
        const percentage = Math.min(100, Math.max(0, (current / target) * 100));
        const isCompleted = current >= target;
        
        return (
          <div className="w-full bg-slate-800 rounded-xl p-3 border border-slate-700 shadow-md">
            <div className="flex justify-between items-end mb-1">
              <span className="text-xs font-semibold uppercase tracking-wider text-slate-400">{label}</span>
              <span className="text-xs font-mono text-slate-300">
                <span className={isCompleted ? "text-emerald-400 font-bold" : "text-white"}>{current}</span>
                <span className="text-slate-600"> / </span>
                {target}
              </span>
            </div>
            <div className="w-full bg-slate-900 rounded-full h-2.5 overflow-hidden">
              <div 
                className={`h-2.5 rounded-full transition-all duration-500 ease-out ${isCompleted ? 'bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)]' : colorClass}`} 
                style={{ width: `${percentage}%` }}
              ></div>
            </div>
          </div>
        );
      };

      // Inline Icons
      const IconStairs = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className || "w-6 h-6"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 6l4 14"/><path d="M12 6l4 14"/><path d="M8 8v12"/><path d="M4 10v10"/></svg>
      );

      const IconCheck = () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      );

      const IconZap = () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      );

      const IconPlay = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      );

      const IconStop = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
      );

      const IconRefresh = () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      );
      
      const IconHistory = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
      );

      const IconArrowLeft = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      );

      const IconTrash = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      );

      const IconSettings = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      );

      const IconMountain = ({ className }) => (
         <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 3 4 8 5-5 5 15H2L8 3z"></path></svg>
      );
      
      const IconFire = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.332-.224-4.218 1.149-5.716C12.418 1.97 14.773 2.5 15.655 5c.783 2.22-1.298 3.504-1.155 5.5.093 1.3.652 2.373 1.134 2.879 1.137 1.192 2.366 1.127 2.366 1.127A8 8 0 1 1 9 5.539c0 .736.334 2.126.826 3.037.195.362.536.637.77.924a2.502 2.502 0 0 1 .581 1.776z"></path></svg>
      );

      const IconFootprints = ({ className }) => (
         <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 2.25-6 6.05-6 3.8 0 6.05 3.28 6.05 6v2c0 2.21-1.79 4-4 4h-4z"/>
            <path d="M20 20v-2.38c0-2.12-1.03-3.12-1-5.62.03-2.72 2.25-6 6.05-6 3.8 0 6.05 3.28 6.05 6v2c0 2.21-1.79 4-4 4h-4z"/>
         </svg>
      );
      
      const IconRuler = ({ className }) => (
         <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M2 12h20"/><path d="M5 12v-4"/><path d="M9 12v-2"/><path d="M13 12v-4"/><path d="M17 12v-2"/>
         </svg>
      );
      
      const IconShare = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
      );

      // --- Helpers ---

      const formatTime = (ms) => {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const pad = (n) => n.toString().padStart(2, '0');
        
        if (hours > 0) {
          return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }
        return `${pad(minutes)}:${pad(seconds)}`;
      };

      const formatDate = (timestamp) => {
        return new Date(timestamp).toLocaleDateString('es-ES', {
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
      };
      
      const calculateElevation = (flights) => {
         // flights * steps_per_flight * height_in_meters
         return (flights * STEPS_PER_FLIGHT * STEP_HEIGHT_METERS).toFixed(1);
      };

      const isSameDay = (d1, d2) => {
        const date1 = new Date(d1);
        const date2 = new Date(d2);
        return date1.toDateString() === date2.toDateString();
      };

      const isSameWeek = (d1, d2) => {
        const date1 = new Date(d1);
        const date2 = new Date(d2);
        date1.setHours(0,0,0,0);
        date2.setHours(0,0,0,0);
        const day1 = date1.getDay() || 7;
        const day2 = date2.getDay() || 7;
        if (day1 !== 1) date1.setHours(-24 * (day1 - 1));
        if (day2 !== 1) date2.setHours(-24 * (day2 - 1));
        return date1.getTime() === date2.getTime();
      }

      // --- Views ---

      const HistoryView = ({ onBack }) => {
        const [history, setHistory] = useState([]);

        useEffect(() => {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            setHistory(JSON.parse(stored));
          }
        }, []);

        const clearHistory = () => {
          if(confirm('¬øBorrar todo el historial?')) {
            localStorage.removeItem(STORAGE_KEY);
            setHistory([]);
          }
        };

        const totalElevationAllTime = useMemo(() => {
           return history.reduce((acc, curr) => acc + (curr.flights * STEPS_PER_FLIGHT * STEP_HEIGHT_METERS), 0).toFixed(0);
        }, [history]);

        return (
          <div className="h-[100dvh] w-full flex flex-col bg-slate-900 text-white relative overflow-hidden">
             <header className="pt-safe pt-4 pb-2 px-4 flex items-center justify-between z-10 bg-slate-900 border-b border-slate-800 shrink-0">
                <button onClick={onBack} className="p-2 text-slate-400 hover:text-white">
                  <IconArrowLeft className="w-6 h-6" />
                </button>
                <h1 className="text-lg font-bold uppercase tracking-wider text-slate-200">Historial</h1>
                <button onClick={clearHistory} className="p-2 text-slate-400 hover:text-red-400">
                  <IconTrash className="w-5 h-5" />
                </button>
             </header>

             <main className="flex-1 overflow-y-auto p-4 space-y-4 pb-safe">
                
                {history.length > 0 && (
                   <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex items-center justify-between">
                      <span className="text-slate-400 text-sm font-semibold uppercase">Total Acumulado</span>
                      <div className="flex items-center gap-2 text-amber-400">
                        <IconMountain className="w-5 h-5" />
                        <span className="text-xl font-bold font-mono">+{totalElevationAllTime} m</span>
                      </div>
                   </div>
                )}

                {history.length === 0 ? (
                  <div className="flex flex-col items-center justify-center h-48 text-slate-500 opacity-50 space-y-4">
                    <IconHistory className="w-16 h-16" />
                    <p>No hay entrenamientos guardados</p>
                  </div>
                ) : (
                  history.map((workout) => (
                    <div key={workout.id} className="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-md">
                      <div className="flex justify-between items-start mb-3 border-b border-slate-700 pb-2">
                        <span className="text-slate-400 text-sm font-mono">{formatDate(workout.endTime)}</span>
                        <span className="text-emerald-400 font-bold font-mono">{formatTime(workout.duration)}</span>
                      </div>
                      
                      {/* Grid for metrics: 3 columns to fit 6 items comfortably */}
                      <div className="grid grid-cols-3 gap-y-3 gap-x-2">
                        
                        {/* 1. Flights */}
                        <div className="text-center">
                          <span className="block text-lg font-bold text-white">{workout.flights}</span>
                          <span className="text-[9px] text-slate-500 uppercase">Tramos</span>
                        </div>
                        
                        {/* 2. Steps (Calculated) */}
                        <div className="text-center">
                          <span className="block text-lg font-bold text-emerald-200">{workout.flights * STEPS_PER_FLIGHT}</span>
                          <span className="text-[9px] text-slate-500 uppercase">Escalones</span>
                        </div>
                        
                        {/* 3. Distance (Calculated) */}
                        <div className="text-center">
                          <span className="block text-lg font-bold text-slate-300">{workout.flights * DISTANCE_PER_FLIGHT_METERS}m</span>
                          <span className="text-[9px] text-slate-500 uppercase">Distancia</span>
                        </div>
                        
                        {/* 4. Elevation */}
                        <div className="text-center">
                          <span className="block text-lg font-bold text-amber-400">+{calculateElevation(workout.flights)}m</span>
                          <span className="text-[9px] text-slate-500 uppercase">Desnivel</span>
                        </div>

                        {/* 5. 2x2 Series */}
                         <div className="text-center">
                          <span className="block text-lg font-bold text-blue-400">{workout.twoStepSeries}</span>
                          <span className="text-[9px] text-slate-500 uppercase">2x2</span>
                        </div>
                        
                        {/* 6. Calories */}
                         <div className="text-center">
                          <span className="block text-lg font-bold text-orange-400">{workout.calories || '-'}</span>
                          <span className="text-[9px] text-slate-500 uppercase">Kcal</span>
                        </div>
                      </div>
                    </div>
                  ))
                )}
             </main>
          </div>
        );
      };

      const SettingsView = ({ onBack, onSave }) => {
        // Default Config
        const [config, setConfig] = useState({
          enabled: true,
          period: 'daily', // 'daily' | 'weekly'
          metric: 'flights', // 'flights' | 'steps'
          target: 100
        });

        useEffect(() => {
          const stored = localStorage.getItem(GOAL_KEY);
          if (stored) {
            setConfig(JSON.parse(stored));
          }
        }, []);

        const handleSave = () => {
          localStorage.setItem(GOAL_KEY, JSON.stringify(config));
          onSave(config);
          onBack();
        };

        return (
          <div className="h-[100dvh] w-full flex flex-col bg-slate-900 text-white relative overflow-hidden">
             <header className="pt-safe pt-4 pb-2 px-4 flex items-center justify-between z-10 bg-slate-900 border-b border-slate-800 shrink-0">
                <button onClick={onBack} className="p-2 text-slate-400 hover:text-white">
                  <IconArrowLeft className="w-6 h-6" />
                </button>
                <h1 className="text-lg font-bold uppercase tracking-wider text-slate-200">Objetivos</h1>
                <div className="w-10"></div> {/* Spacer */}
             </header>

             <main className="flex-1 overflow-y-auto p-6 space-y-8 pb-safe">
               
               <div className="space-y-4">
                 <label className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                   <span className="font-semibold text-slate-200">Activar Objetivo</span>
                   <input 
                    type="checkbox" 
                    checked={config.enabled}
                    onChange={(e) => setConfig({...config, enabled: e.target.checked})}
                    className="w-6 h-6 rounded bg-slate-700 border-slate-600 text-emerald-500 focus:ring-emerald-500"
                   />
                 </label>

                 <div className={`space-y-6 transition-opacity ${config.enabled ? 'opacity-100' : 'opacity-40 pointer-events-none'}`}>
                   <div>
                     <label className="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wide">Frecuencia</label>
                     <div className="grid grid-cols-2 gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700">
                        <button 
                          onClick={() => setConfig({...config, period: 'daily'})}
                          className={`py-2 rounded-lg text-sm font-bold transition-colors ${config.period === 'daily' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                        >
                          Diaria
                        </button>
                        <button 
                          onClick={() => setConfig({...config, period: 'weekly'})}
                          className={`py-2 rounded-lg text-sm font-bold transition-colors ${config.period === 'weekly' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                        >
                          Semanal
                        </button>
                     </div>
                   </div>

                   <div>
                     <label className="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wide">M√©trica</label>
                     <div className="grid grid-cols-2 gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700">
                        <button 
                          onClick={() => setConfig({...config, metric: 'flights'})}
                          className={`py-2 rounded-lg text-sm font-bold transition-colors ${config.metric === 'flights' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                        >
                          Tramos
                        </button>
                        <button 
                          onClick={() => setConfig({...config, metric: 'steps'})}
                          className={`py-2 rounded-lg text-sm font-bold transition-colors ${config.metric === 'steps' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                        >
                          Escalones
                        </button>
                     </div>
                   </div>

                   <div>
                      <label className="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wide">
                        Objetivo ({config.metric === 'flights' ? 'Tramos' : 'Pasos'})
                      </label>
                      <input 
                        type="number" 
                        value={config.target}
                        onChange={(e) => setConfig({...config, target: parseInt(e.target.value) || 0})}
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-2xl font-mono text-center text-white focus:outline-none focus:border-emerald-500"
                        inputMode="numeric"
                      />
                      <p className="text-xs text-center text-slate-500 mt-2">
                        {config.metric === 'flights' 
                          ? `‚âà ${config.target * STEPS_PER_FLIGHT} escalones`
                          : `‚âà ${Math.floor(config.target / STEPS_PER_FLIGHT)} tramos`
                        }
                      </p>
                   </div>
                 </div>
               </div>

               <button
                  onClick={handleSave}
                  className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white transition-colors shadow-lg shadow-emerald-900/20"
                >
                  Guardar Cambios
               </button>

             </main>
          </div>
        );
      }

      // --- Main App Logic ---

      function App() {
        const [view, setView] = useState('home'); // 'home' | 'history' | 'settings'
        const [status, setStatus] = useState('idle');
        const [stats, setStats] = useState({
          flights: 0,
          twoStepSeries: 0,
          startTime: null,
          endTime: null,
          elapsedTime: 0,
        });
        
        // Goal State
        const [goalConfig, setGoalConfig] = useState(null);
        const [progress, setProgress] = useState(0);

        // History Update State
        const [currentWorkoutId, setCurrentWorkoutId] = useState(null);
        const [manualCalories, setManualCalories] = useState('');

        const timerRef = useRef(null);

        // Load Goal Config on mount
        useEffect(() => {
          const storedGoal = localStorage.getItem(GOAL_KEY);
          if (storedGoal) {
            setGoalConfig(JSON.parse(storedGoal));
          } else {
             // Default goal if none exists
             setGoalConfig({ enabled: true, period: 'daily', metric: 'flights', target: 50 });
          }
        }, []);

        // Calculate Progress (History + Current)
        const calculateProgress = useCallback(() => {
           if (!goalConfig || !goalConfig.enabled) return 0;

           const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
           const now = new Date();

           // 1. Filter relevant history
           const filteredHistory = history.filter(item => {
              if (goalConfig.period === 'daily') {
                return isSameDay(item.endTime, now);
              } else {
                return isSameWeek(item.endTime, now);
              }
           });

           // 2. Sum up stored stats
           let total = 0;
           filteredHistory.forEach(item => {
              if (goalConfig.metric === 'flights') {
                total += item.flights;
              } else {
                total += (item.flights * STEPS_PER_FLIGHT); // Assuming only flights count as steps for simplified tracking
              }
           });

           // 3. Add current live session stats
           if (goalConfig.metric === 'flights') {
             total += stats.flights;
           } else {
             total += (stats.flights * STEPS_PER_FLIGHT);
           }
           
           return total;

        }, [goalConfig, stats.flights]);

        // Update progress whenever stats or config changes
        useEffect(() => {
          if (goalConfig) {
            setProgress(calculateProgress());
          }
        }, [stats.flights, goalConfig, calculateProgress]);


        // Timer Logic
        useEffect(() => {
          if (status === 'running') {
            const startTime = Date.now() - stats.elapsedTime;
            timerRef.current = window.setInterval(() => {
              setStats(prev => ({
                ...prev,
                elapsedTime: Date.now() - startTime
              }));
            }, 100);
          } else {
            if (timerRef.current) {
              clearInterval(timerRef.current);
            }
          }

          return () => {
            if (timerRef.current) clearInterval(timerRef.current);
          };
        }, [status]); 

        const startWorkout = useCallback(() => {
          setStatus('running');
          setStats(prev => ({ ...prev, startTime: Date.now() }));
        }, []);

        const saveWorkoutToHistory = useCallback((finalStats) => {
           const newWorkout = {
             id: Date.now(),
             startTime: finalStats.startTime,
             endTime: Date.now(),
             duration: finalStats.elapsedTime,
             flights: finalStats.flights,
             twoStepSeries: finalStats.twoStepSeries,
             calories: null // Placeholder for manual entry
           };
           
           try {
             const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
             // Add to beginning of array
             const updated = [newWorkout, ...existing];
             localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
             return newWorkout.id;
           } catch (e) {
             console.error("Error saving workout", e);
             return null;
           }
        }, []);

        const updateWorkoutCalories = useCallback((id, calories) => {
            if(!id) return;
            try {
                const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const updatedHistory = history.map(w => {
                    if (w.id === id) {
                        return { ...w, calories: parseInt(calories) || 0 };
                    }
                    return w;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedHistory));
            } catch(e) { console.error("Error updating calories", e); }
        }, []);

        const finishWorkout = useCallback(() => {
          setStatus('finished');
          const finalEndTime = Date.now();
          setStats(prev => {
             const finalStats = { ...prev, endTime: finalEndTime };
             const id = saveWorkoutToHistory(finalStats);
             setCurrentWorkoutId(id);
             return finalStats;
          });
          setManualCalories('');
        }, [saveWorkoutToHistory]);

        const resetWorkout = useCallback(() => {
          setStatus('idle');
          setStats({
            flights: 0,
            twoStepSeries: 0,
            startTime: null,
            endTime: null,
            elapsedTime: 0,
          });
          setCurrentWorkoutId(null);
          setManualCalories('');
        }, []);

        const addFlight = useCallback(() => {
          if (status !== 'running') return;
          setStats(prev => ({ ...prev, flights: prev.flights + 1 }));
          if (navigator.vibrate) navigator.vibrate(50);
        }, [status]);

        const addSeries = useCallback(() => {
          if (status !== 'running') return;
          setStats(prev => ({ 
            ...prev, 
            twoStepSeries: prev.twoStepSeries + 1,
            flights: prev.flights + 1
          }));
          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        }, [status]);

        const totalStepsUp = stats.flights * STEPS_PER_FLIGHT;
        const totalStepsDown = stats.flights * STEPS_PER_FLIGHT;
        const totalSteps = totalStepsUp + totalStepsDown;
        const currentElevation = calculateElevation(stats.flights);

        // --- View Routing ---
        if (view === 'history') {
          return <HistoryView onBack={() => setView('home')} />;
        }

        if (view === 'settings') {
          return (
            <SettingsView 
              onBack={() => setView('home')} 
              onSave={(newConfig) => setGoalConfig(newConfig)} 
            />
          );
        }

        // --- Render: Finished Screen ---
        if (status === 'finished') {
          const handleShare = async () => {
            const text = `üßó Entrenamiento StairMaster Finalizado\n\n` +
              `‚è±Ô∏è Tiempo: ${formatTime(stats.elapsedTime)}\n` +
              `üè¢ Tramos: ${stats.flights}\n` +
              `üë£ Pasos: ${totalSteps}\n` +
              `üèîÔ∏è Desnivel: +${currentElevation}m\n` +
              `‚ö° Series 2x2: ${stats.twoStepSeries}\n` +
              (manualCalories ? `üî• Calor√≠as: ${manualCalories} kcal\n` : '') +
              `\n#StairMaster`;

            if (navigator.share) {
              try {
                await navigator.share({
                  title: 'Resumen Entrenamiento',
                  text: text,
                });
              } catch (err) {
                console.log('Error sharing:', err);
              }
            } else {
              try {
                await navigator.clipboard.writeText(text);
                alert('¬°Resumen copiado al portapapeles!');
              } catch (err) {
                console.error('Clipboard error', err);
              }
            }
          };

          return (
            <div className="h-[100dvh] w-full flex flex-col items-center justify-center p-6 bg-slate-900 text-white overflow-y-auto pt-safe pb-safe">
              <div className="w-full max-w-md space-y-6 animate-fade-in my-auto">
                <div className="text-center">
                  <h2 className="text-3xl font-bold text-emerald-400 mb-2">¬°Entrenamiento Fin!</h2>
                  <p className="text-slate-400">Guardado en el historial.</p>
                </div>

                <div className="bg-slate-800 rounded-3xl p-6 border border-slate-700 shadow-2xl space-y-6">
                  <div className="text-center pb-6 border-b border-slate-700">
                     <span className="text-slate-400 text-sm uppercase tracking-wide">Tiempo Total</span>
                     <div className="text-5xl font-black font-mono text-white mt-2">
                       {formatTime(stats.elapsedTime)}
                     </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-slate-700/50 p-4 rounded-xl text-center">
                      <div className="text-slate-400 text-xs mb-1">Total Tramos</div>
                      <div className="text-3xl font-bold text-emerald-400">{stats.flights}</div>
                    </div>
                    <div className="bg-slate-700/50 p-4 rounded-xl text-center">
                      <div className="text-slate-400 text-xs mb-1">Desnivel +</div>
                      <div className="text-3xl font-bold text-amber-400">+{currentElevation}m</div>
                    </div>
                  </div>
                  
                  {/* Manual Calories Input */}
                  <div className="bg-slate-900/80 p-4 rounded-xl border border-slate-700 flex items-center gap-4 transition-colors focus-within:border-orange-500/50">
                    <div className="p-3 bg-orange-500/20 rounded-full text-orange-500 shrink-0">
                        <IconFire className="w-6 h-6" />
                    </div>
                    <div className="flex-1 min-w-0">
                        <label className="block text-[10px] text-slate-400 uppercase tracking-wider mb-1">Calor√≠as (Opcional)</label>
                        <input 
                            type="number" 
                            value={manualCalories}
                            onChange={(e) => {
                                const val = e.target.value;
                                setManualCalories(val);
                                updateWorkoutCalories(currentWorkoutId, val);
                            }}
                            placeholder="0"
                            className="w-full bg-transparent text-2xl font-bold text-white focus:outline-none placeholder-slate-700 font-mono"
                        />
                    </div>
                    <span className="text-slate-500 font-bold text-xs uppercase self-end mb-2">kcal</span>
                  </div>

                  <div className="space-y-3 pt-2 border-t border-slate-700">
                     <div className="flex justify-between items-center text-base">
                      <span className="text-slate-300 font-semibold">Series 2x2</span>
                      <span className="font-bold text-xl text-blue-400">{stats.twoStepSeries}</span>
                    </div>
                     <div className="flex justify-between items-center text-base">
                      <span className="text-slate-300 font-semibold">Total Movimiento</span>
                      <span className="font-bold text-xl text-white">{totalSteps}</span>
                    </div>
                  </div>
                </div>

                <div className="space-y-3">
                   <button
                    onClick={handleShare}
                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-white transition-colors flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/20"
                  >
                    <IconShare className="w-5 h-5" /> Compartir Resultado
                  </button>

                   <button
                    onClick={() => { resetWorkout(); setView('history'); }}
                    className="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-semibold text-slate-300 transition-colors flex items-center justify-center gap-2"
                  >
                    <IconHistory className="w-5 h-5" /> Ver Historial
                  </button>
                  <button
                    onClick={resetWorkout}
                    className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white transition-colors flex items-center justify-center gap-2 mb-safe"
                  >
                    <IconRefresh /> Nuevo Entrenamiento
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // --- Render: Main App (Idle or Running) ---
        return (
          // Use h-[100dvh] to respect mobile browser address bars
          <div className="h-[100dvh] w-full flex flex-col bg-slate-900 text-white relative overflow-hidden">
            
            {/* Header - Sticky */}
            <header className="pt-safe pt-2 pb-2 px-6 flex items-center justify-between z-10 bg-slate-900/95 backdrop-blur-sm border-b border-slate-800 shrink-0">
               <button onClick={() => setView('settings')} className="p-2 -ml-2 text-slate-500 hover:text-white transition-colors">
                  <IconSettings className="w-6 h-6" />
               </button>
               
               <div className="flex flex-col items-center">
                 <h1 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">Cron√≥metro</h1>
                 <div className={`text-4xl sm:text-5xl font-black font-mono tracking-tighter transition-colors ${status === 'running' ? 'text-white' : 'text-slate-500'}`}>
                  {formatTime(stats.elapsedTime)}
                 </div>
               </div>
               
               <div className="w-8"></div> {/* Spacer for alignment */}
            </header>

            {/* Main Content - Scrollable */}
            <main className="flex-1 p-4 sm:p-6 overflow-y-auto space-y-3 overscroll-contain">
              
              {/* Goal Progress Bar */}
              {goalConfig && goalConfig.enabled && (
                <div className="mb-2">
                   <ProgressBar 
                      current={progress} 
                      target={goalConfig.target} 
                      label={`Meta ${goalConfig.period === 'daily' ? 'Diaria' : 'Semanal'} (${goalConfig.metric === 'flights' ? 'Tramos' : 'Pasos'})`}
                   />
                </div>
              )}

              <div className="grid grid-cols-2 gap-3 sm:gap-4">
                 <StatCard 
                    label="Escalones UP" 
                    value={totalStepsUp} 
                    colorClass="text-emerald-400"
                    subLabel={`(${stats.flights} tramos)`}
                  />
                 <StatCard 
                    label="Desnivel +" 
                    value={`${currentElevation}m`}
                    colorClass="text-amber-400"
                    subLabel={`(19cm/paso)`}
                  />
              </div>

              <div className="grid grid-cols-2 gap-3 sm:gap-4">
                 <StatCard 
                    label="Total Tramos" 
                    value={stats.flights} 
                    colorClass="text-white"
                  />
                  <StatCard 
                    label="Series 2x2" 
                    value={stats.twoStepSeries} 
                    colorClass="text-blue-400"
                  />
              </div>

              {status === 'idle' && (
                 <div className="mt-4 text-center p-6 border-2 border-dashed border-slate-700 rounded-2xl text-slate-500">
                   <p className="mb-2 text-sm">Pulsa INICIO para comenzar</p>
                   <div className="flex justify-center opacity-50"><IconStairs className="w-8 h-8" /></div>
                 </div>
              )}
            </main>

            {/* Footer - Fixed/Sticky Bottom with Safe Area */}
            <footer className="p-4 sm:p-6 bg-slate-900 border-t border-slate-800 z-20 pb-safe shrink-0">
              {status === 'idle' ? (
                <div className="space-y-3 mb-2">
                  <button
                    onClick={startWorkout}
                    className="w-full py-6 bg-emerald-600 hover:bg-emerald-500 active:scale-95 transition-all rounded-2xl shadow-lg shadow-emerald-900/50 flex items-center justify-center gap-3"
                  >
                    <IconPlay className="w-8 h-8" />
                    <span className="text-2xl font-bold uppercase tracking-wide">Iniciar</span>
                  </button>
                  <button
                    onClick={() => setView('history')}
                    className="w-full py-3 bg-slate-800 hover:bg-slate-700 active:scale-95 transition-all rounded-xl text-slate-400 font-semibold flex items-center justify-center gap-2"
                  >
                    <IconHistory className="w-5 h-5" /> Historial
                  </button>
                </div>
              ) : (
                <div className="space-y-3 mb-2">
                  <div className="grid grid-cols-2 gap-3 h-32 sm:h-36">
                    <button
                      onClick={addFlight}
                      className="relative bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 active:scale-95 transition-all rounded-2xl shadow-lg shadow-emerald-900/20 flex flex-col items-center justify-center group touch-manipulation"
                    >
                      <div className="absolute top-2 right-2 opacity-50 group-active:opacity-100">
                          <span className="text-xs font-bold text-emerald-200">+31</span>
                      </div>
                      <IconCheck />
                      <span className="text-lg font-bold mt-1 uppercase leading-none">Tramo OK</span>
                    </button>

                    <button
                      onClick={addSeries}
                      className="relative bg-blue-600 hover:bg-blue-500 active:bg-blue-700 active:scale-95 transition-all rounded-2xl shadow-lg shadow-blue-900/20 flex flex-col items-center justify-center group touch-manipulation"
                    >
                       <div className="absolute top-2 right-2 opacity-50 group-active:opacity-100">
                          <span className="text-xs font-bold text-blue-200">+1</span>
                      </div>
                      <IconZap />
                      <span className="text-lg font-bold mt-1 uppercase leading-none">Serie 2x2</span>
                    </button>
                  </div>

                  <button
                    onClick={finishWorkout}
                    className="w-full py-4 bg-slate-800 hover:bg-slate-700 active:bg-slate-800 border-2 border-slate-700 rounded-xl text-slate-300 font-semibold uppercase tracking-wider flex items-center justify-center gap-2"
                  >
                    <IconStop className="w-5 h-5" /> Terminar Sesi√≥n
                  </button>
                </div>
              )}
            </footer>
          </div>
        );
      }

      // --- Entry Point ---
      
      const rootElement = document.getElementById('root');
      const root = createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );

      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./serviceWorker.ts').then(
            (registration) => {
              console.log('SW Registered');
            },
            (err) => {
              console.log('SW Failed:', err);
            }
          );
        });
      }
    </script>
  </body>
</html>